<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Maze</title>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g="
            crossorigin="anonymous"></script>
    <style media="screen">
        .mapa {
            /*transform: rotateZ(150deg) rotateY(36deg) rotateX(45deg) translateX(-5rem) translateY(-10rem);*/
            transform: rotateX(60deg) rotateZ(-45deg);
            transform-style: preserve-3d;
            background-color: rgb(192, 255, 255);
            margin: auto;
            display: flex;
            flex-flow: row wrap;
        }

        .tile {
            background-color: rgba(200, 200, 200, 0.5);
            border: 1px solid black;
        }

            .tile:hover {
                background-color: rgba(200, 200, 200, 1);
            }

        .tile--PATH {
            background-color: rgba(222, 200, 161, 1);
        }

        .tile--GRASS {
            background-color: rgba(56, 96, 34, 0.94);
        }

        .tile--WATER {
            background-color: rgba(0, 148, 255, 0.98);
        }

        .tile--STONE {
            background-color: rgba(150, 150, 150, 0.94);
        }

        .tile--SAND {
            background-color: rgba(213, 161, 38, 0.94);
        }

        .tile--MUD {
            background-color: rgba(57, 31, 9, 0.94);
        }

        .tile--ICE {
            background-color: rgba(150, 150, 150, 1);
        }
    </style>
</head>
<body>
    <div id="mapa" class="mapa">

    </div>
    <script type="text/javascript">
        var maze = (function ($document, $window, $) {
            var _private = {};
            var _public = {};
            var mapaController = {};
            var tileController = {};
            var exitsController = {};
            exitsController.props = {
                maxExits: 4,
                currentExits: [],
                exitPrototype: (function (to, x, y, needKey) {
                    return {
                        to: to,
                        x: x,
                        y: y,
                        needkey: needKey
                    };
                })
            };
            exitsController.createExit = (function () {
                existsController.currentExits.push();
            });
            tileController.props = {
                height: 1,
                width: 1,
                tiles: [[]],
                tilesTypes: [
                    { i: 0, description: 'GRASS', affinity: [0, 1, 2, 3, 4, 5] },
                    { i: 1, description: 'PATH', affinity: [0, 1, 2, 3, 4, 5, 6, 7, 8] },
                    { i: 2, description: 'WATER', affinity: [0, 1, 2, 3, 4, 5, 6] },
                    { i: 3, description: 'STONE', affinity: [0, 1, 2, 3, 4, 5, 6, 7, 8] },
                    { i: 4, description: 'SAND', affinity: [0, 1, 2, 3, 4] },
                    { i: 5, description: 'MUD', affinity: [0, 1, 2, 3, 5] },
                    { i: 6, description: 'ICE', affinity: [1, 2, 3, 6] },
                    { i: 7, description: 'ASH', affinity: [1, 2, 3, 4, 7] },
                    { i: 8, description: 'LAVA', affinity: [1, 3, 4, 7, 8] }
                ],
                siblingsPrototype: (function () {
                    return {
                        N: null,
                        S: null,
                        W: null,
                        E: null,
                        NW: null,
                        NE: null,
                        SW: null,
                        SE: null
                    }
                }),
                tilePrototype: (function (tileType, x, y, side) {
                    return {
                        x: x,
                        y: y,
                        side: side,
                        tileType: tileType
                    };
                })
            };
            tileController.getTileType = (function (tileTypeDefault, sN, sNW, sW) {
                try {
                    var tileType;
                    var max = tileController.props.tilesTypes.length - 1;
                    if (sW == null && sNW == null && sN == null) 
                        tileType = tileController.props.tilesTypes[Math.round(Math.random() * max)];



                    if (tileType == null || tileType == undefined)
                        tileType = tileTypeDefault;

                    return tileType;

                } catch (e) {
                    return tileTypeDefault;
                }
            });
            tileController.getsiblings = (function (currX, currY) {
                var siblings = {};
                siblings.N = tileController.getsibling(currX, currY, 'N');
                siblings.S = tileController.getsibling(currX, currY, 'S');
                siblings.E = tileController.getsibling(currX, currY, 'E');
                siblings.W = tileController.getsibling(currX, currY, 'W');
                siblings.NE = tileController.getsibling(currX, currY, 'NE');
                siblings.NW = tileController.getsibling(currX, currY, 'NW');
                siblings.SE = tileController.getsibling(currX, currY, 'SE');
                siblings.SW = tileController.getsibling(currX, currY, 'SW');
                return siblings;
            });
            _public.siblings = (function (currX, currY) {
                return tileController.getsiblings(currX, currY);
            });
            tileController.getsibling = (function (currX, currY, direction) {
                if (currX < 0 || currY < 0 || currX > mapaController.props.width - 1 || currY > mapaController.props.height - 1)
                    return null;
                try {
                    if (direction == 'N' && currY - 1 >= 0)
                        return tileController.props.tiles[currX][currY - 1];

                    if (direction == 'S' && currY + 1 <= mapaController.props.height - 1)
                        return tileController.props.tiles[currX][currY + 1];

                    if (direction == 'W' && currX - 1 >= 0)
                        return tileController.props.tiles[currX - 1][currY];

                    if (direction == 'E' && currX + 1 <= mapaController.props.width - 1)
                        return tileController.props.tiles[currX + 1][currY];

                    if (direction == 'NE' && currX + 1 <= mapaController.props.width - 1 && currY - 1 >= 0)
                        return tileController.props.tiles[currX + 1][currY - 1];

                    if (direction == 'NW' && currX - 1 >= 0 && currY - 1 >= 0)
                        return tileController.props.tiles[currX - 1][currY - 1];

                    if (direction == 'SE' && currX + 1 <= mapaController.props.width - 1 && currY + 1 <= mapaController.props.height - 1)
                        return tileController.props.tiles[currX][currY - 1];

                    if (direction == 'SW' && currX - 1 >= 0 && currY + 1 <= mapaController.props.height - 1)
                        return tileController.props.tiles[currX][currY - 1];

                } catch (e) {
                    return null;
                }
                return null;
            });
            tileController.createTile = (function (x, y, side) {
                var siblings = tileController.props.siblingsPrototype();
                siblings.N = tileController.getsibling(x, y, 'N');
                siblings.NW = tileController.getsibling(x, y, 'NW');
                siblings.W = tileController.getsibling(x, y, 'W');

                var tileType = tileController.getTileType(siblings.N, siblings.NW, siblings.W);
                var tile = tileController.props.tilePrototype(tileType, x, y, side);
                if (tileController.props.tiles[x] === undefined)
                    tileController.props.tiles[x] = [];
                console.log(tile);
                tileController.props.tiles[x][y] = tile;
                return tile;
            });
            tileController.renderTiles = (function (mapa) {
                for (var row of tileController.props.tiles) {
                    for(var col of row) {
                        var currTile = $('<div/>').addClass('tile tile--' + col.tileType.description)
                        .attr({
                            x: col.x,
                            y: col.y
                        })
                        .css({
                            height: col.side - 2 + 'px',
                            width: col.side - 2 + 'px'
                        });
                        mapa.append(currTile);
                    }
                }
            });
            mapaController.props = {
                tileSide: 40,
                height: 16,
                width: 16,
                mapaObj: null
            };
            mapaController.renderMap = (function () {
                mapaController.props.mapaObj.css({
                    height: (mapaController.props.height * mapaController.props.tileSide + 2) + 'px',
                    width: (mapaController.props.width * mapaController.props.tileSide + 2) + 'px',
                });
                for (var i = 0; i < mapaController.props.width; i++) {
                    for (var j = 0; j < mapaController.props.height; j++) {
                        tileController.createTile(i, j, mapaController.props.tileSide);
                    }
                }
                tileController.renderTiles(mapaController.props.mapaObj);
            });
            mapaController.init = (function (opt) {
                if (!!opt.height) {
                    mapaController.props.height = opt.height;
                }
                if (!!opt.width) {
                    mapaController.props.width = opt.width;
                }
                if (!!opt.tileSide) {
                    mapaController.props.tileSide = opt.tileSide;
                }
                if (!!opt.mapaObj) {
                    mapaController.props.mapaObj = opt.mapaObj;
                }

                mapaController.renderMap();

            });
            _private.init = (function () {
                mapaController.init({
                    mapaObj: $('#mapa')
                });
            });
            $window.addEventListener('DOMContentLoaded', _private.init);

            return _public;

        })(document, window, $);
    </script>
</body>
</html>
